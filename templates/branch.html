{% extends 'base.html' %}
{% load static %}
{% load form_extras %}
{% block title %}{{ branch.name }}{% endblock %}

{% block extra_css %}

<style>
    .branch-detail .branch-info {
        display: flex !important;
        flex-direction: row !important;
        gap: 40px !important;
        align-items: stretch !important;
    }

    .branch-detail .branch-text {
        flex: 1 1 35% !important;
        /* was 2 -> make half */
        display: flex !important;
        flex-direction: column !important;
        gap: 30px !important;
    }

    .branch-detail .branch-image {
        flex: 1 1 65% !important;
        /* make half */
        max-width: 65% !important;
        /* remove 90%, force half */
        aspect-ratio: 4 / 3;
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        background: #f3f3f3;
    }

    .branch-detail .branch-image img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        /* or contain */
        margin: 0;
    }

    .hours-item.current-day {
        font-weight: bold !important;
        background: #e3f2fd !important;
        padding: 8px 12px !important;
        margin: 0 -12px !important;
        border-radius: 4px !important;
    }

    .always-open {
        font-weight: bold !important;
        color: #28a745 !important;
        font-size: 1.1em !important;
    }

    @media (max-width: 900px) {
        .branch-detail .branch-info {
            flex-direction: column !important;
        }

        .branch-detail .branch-image,
        .branch-detail .branch-text {
            max-width: 100% !important;
            flex: 1 1 100% !important;
        }
    }
    /* Removed legacy oversize padding for primary button; unified sizing now via .action-btn in global stylesheet */

    /* Inline appointment overlay positioning to the right of the trigger button */
    .branch-appointment {
        position: relative; /* anchor for absolute overlay */
    }
    .branch-appointment .appointment-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1001;
        width: 420px;
        max-width: 90vw;
        box-shadow: 0 12px 32px rgba(0,0,0,0.25);
    }
    .branch-appointment .appointment-overlay .card {
        margin: 0; /* remove default spacing */
    }
    /* Arrow pointer (optional) */
    .branch-appointment .appointment-overlay::before { display:none; }

    /* Backdrop */
    .appointment-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        backdrop-filter: blur(2px);
        z-index: 1000;
        display: none;
    }
    /* Responsive fallback: stack below button on narrow screens */
    @media (max-width: 900px) {
        .branch-appointment .appointment-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        .branch-appointment .appointment-overlay::before { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="branch-detail">
    <br>
    <a href="{% url 'branch_list' %}" class="button is-primary">← Back to all branches</a>
    <br>
    <div class="branch-info">
        <div class="branch-text">
            <div class="branch-header">
                <br>
                <h1 class="title">{{ branch.name }}</h1>
            </div>
            <!-- Block 1: Contact Info -->
            <div class="branch-hours">
                <div class="contact-item">
                    <h3>Address</h3>
                    {{ branch.get_formatted_address|safe }}
                    <br>{{ branch.postcode }}
                </div>
            </div>

            <div class="branch-hours">
                {% if branch.phone %}
                <div class="contact-item">
                    <h3>Phone</h3>
                    {{ branch.phone }}
                </div>
                {% endif %}
            </div>

            <!-- Block 2: Opening Hours -->
            <div class="branch-hours">
                <h3>Opening Times</h3>
                {% if branch.is_24_7 %}
                <div class="always-open">Always open</div>
                {% else %}
                <div class="hours-list">
                    {% for hours in branch.get_opening_hours_display %}
                    <div class="hours-item {% if hours.is_current %}current-day{% endif %}">
                        <span class="day">{{ hours.days }}</span>
                        <span class="time">{{ hours.open }} - {{ hours.close }}</span>
                    </div>
                    {% empty %}
                    <div class="hours-item">
                        <span class="day">Hours</span>
                        <span class="time">Please call for details</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Block 3: Appointment Link -->
            <div class="branch-appointment">
                {% if user.is_authenticated %}
                <button id="toggle-inline-appointment" class="button is-primary" type="button">
                    Book Appointment
                </button>
                <div id="appointment-backdrop" class="appointment-backdrop"></div>
                                <div id="inline-appointment-wrapper" class="appointment-overlay" style="display:none;">
                                    <div class="card">
                                        <header class="card-header has-background-primary">
                                            <p class="card-header-title has-text-white">Book at {{ branch.name }}</p>
                                            <button class="card-header-icon" type="button" aria-label="close" id="close-inline-appointment">✕</button>
                                        </header>
                                        <div class="card-content">
                                            <form id="inline-appointment-form" method="post" action="{% url 'appointment_add' %}" novalidate>
                                                {% csrf_token %}
                                                <input type="hidden" name="branch" value="{{ branch.id }}">
                                                <div class="field">
                                                    <label class="label">Vaccine</label>
                                                    <div class="control">{{ inline_appointment_form.vaccine|add_class:'select' }}</div>
                                                </div>
                                                <div class="field">
                                                    <label class="label">Date</label>
                                                    <div class="control">
                                                        <input id="inline-appt-date" class="input" type="date" min="{{ today_str }}">
                                                        <p id="inline-date-error" class="help is-danger" style="display:none;">Branch closed that day</p>
                                                    </div>
                                                </div>
                                                <div class="field">
                                                    <label class="label">Time</label>
                                                    <div id="inline-appt-time-wrapper" class="time-grid"><span id="inline-time-placeholder" class="has-text-grey">Select a date first</span></div>
                                                </div>
                                                <input type="hidden" id="inline-id_datetime" name="datetime">
                                                <div class="field">
                                                    <label class="label">Notes</label>
                                                    <div class="control">{{ inline_appointment_form.notes|add_class:'textarea' }}</div>
                                                </div>
                                                <div class="field is-grouped is-justify-content-space-between">
                                                    <div class="control"><button class="button is-primary action-btn" type="submit">Book</button></div>
                                                    <div class="control"><button class="button is-light action-btn" type="button" id="cancel-inline-appointment">Cancel</button></div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                {% else %}
                <a href="{% url 'login' %}?next={% url 'branch_detail' branch.id %}" class="button is-primary">Log in to book</a>
                {% endif %}
            </div>
        </div>

        <div class="branch-image">
            {% if branch.image_url %}
            {% if branch.image_url|slice:':4' == 'http' %}
            <img src="{{ branch.image_url }}" alt="{{ branch.name }}">
            {% else %}
            <img src="{% static branch.image_url %}" alt="{{ branch.name }}">
            {% endif %}
            {% else %}
            <img src="{% static 'img/branches/placeholder.jpg' %}" alt="{{ branch.name }}">
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
        {% block extra_js %}
    <script id="inline-opening-hours-data" type="application/json">{{ opening_hours_json|safe }}</script>
    <script>
    (function(){
            console.log('[Branch] inline appointment init');
            const btn=document.getElementById('toggle-inline-appointment');
            const wrapper=document.getElementById('inline-appointment-wrapper');
            const closeBtn=document.getElementById('close-inline-appointment');
            const cancelBtn=document.getElementById('cancel-inline-appointment');
            if(!btn||!wrapper){return;}
            const hide=()=>{wrapper.style.display='none';};
            const show=()=>{wrapper.style.display='block';};
            const backdrop=document.getElementById('appointment-backdrop');
            function showAll(){show();if(backdrop){backdrop.style.display='block';}}
            function hideAll(){hide();if(backdrop){backdrop.style.display='none';}}
            btn.addEventListener('click',()=>{wrapper.style.display==='none'?showAll():hideAll();});
            closeBtn&&closeBtn.addEventListener('click',hide);
            cancelBtn&&cancelBtn.addEventListener('click',hideAll);
            backdrop&&backdrop.addEventListener('click',hideAll);
    // load shared script if not already
        if(!window.AppointmentUI){
            const s=document.createElement('script');
            s.src="{% static 'js/appointment_form.js' %}";
            s.onload=initInline;
            document.body.appendChild(s);
        } else {
            initInline();
        }
    function initInline(){AppointmentUI.init({
        hoursDataScriptId:'inline-opening-hours-data',
        dateInputId:'inline-appt-date',
        timeWrapperId:'inline-appt-time-wrapper',
        timePlaceholderId:'inline-time-placeholder',
        hiddenDatetimeId:'inline-id_datetime',
        branchSelectId:'', // branch is fixed via hidden field
        dateErrorId:'inline-date-error',
        interval:30
    });}
})();
        </script>
        {% endblock %}